{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import\"../env\";import{spawnSync}from\"node:child_process\";import path from\"node:path\";import{updateWatchlist}from\"./watchlist\";const MIN_TWITTER_FOLLOWERS=Number(process.env.PROMISING_TWITTER_MIN_FOLLOWERS??5e3);const MIN_FARCASTER_FOLLOWERS=Number(process.env.PROMISING_FARCASTER_MIN_FOLLOWERS??2e3);const SOCIAL_STATS_TTL_MS=Number(process.env.SOCIAL_STATS_TTL_MS??6*60*60*1e3);const SMART_AUTO_RUN=String(process.env.SMART_FOLLOWER_AUTO_RUN??\"false\").toLowerCase()===\"true\";const SMART_AUTO_REFRESH_MS=Number(process.env.SMART_FOLLOWER_AUTO_REFRESH_MS??24*60*60*1e3);const TWITTER_API_BASE=(process.env.TWITTER_API_BASE??\"https://api.twitterapi.io\").replace(/\\/$/,\"\");const TWITTER_API_KEY=process.env.TWITTER_API_KEY;const FARCASTER_USER_API_BASE=process.env.FARCASTER_USER_API_BASE??\"https://api.farcaster.xyz\";const BASE_ROOT=path.resolve(process.cwd(),\"..\");const SMART_SCRIPT_PATH=path.join(BASE_ROOT,\"scripts\",\"countSmartFollowers.js\");const nowIso=__name(()=>new Date().toISOString(),\"nowIso\");const sanitizeHandle=__name(value=>{if(!value)return null;return value.replace(/^@/,\"\").trim()},\"sanitizeHandle\");const parseTwitterHandleFromUrl=__name(value=>{if(!value)return null;try{const url=new URL(value);if(!url.hostname.includes(\"twitter.com\")&&!url.hostname.includes(\"x.com\")){return null}const segments=url.pathname.split(\"/\").filter(Boolean);if(segments.length===0)return null;if(segments[0]===\"i\"&&segments[1]===\"communities\"){return null}return sanitizeHandle(segments[0])}catch{return null}},\"parseTwitterHandleFromUrl\");const extractTwitterHandle=__name(entry=>{const candidates=[entry.identity?.twitter,entry.community?.twitter];entry.community?.socials?.forEach(link=>{if(link.platform?.toLowerCase()===\"twitter\"||link.platform?.toLowerCase()===\"x\"){candidates.push(link.handle??link.url)}});entry.community?.raw?.forEach(link=>{if(link.platform?.toLowerCase()===\"twitter\"||link.platform?.toLowerCase()===\"x\"||link.url?.includes(\"twitter.com\")||link.url?.includes(\"x.com\")){candidates.push(link.handle??link.url)}});for(const candidate of candidates){const handle=sanitizeHandle(candidate)??parseTwitterHandleFromUrl(candidate);if(handle)return handle.toLowerCase()}return null},\"extractTwitterHandle\");const getStatAge=__name(stat=>{if(!stat?.lastCheckedAt)return Infinity;return Date.now()-new Date(stat.lastCheckedAt).getTime()},\"getStatAge\");const mutateIdentity=__name(async(entry,mutator)=>{let snapshot;await updateWatchlist(watchlist=>{const target=watchlist.tokens[entry.token];if(!target)return;const identity=target.identity??{platform:entry.platform??\"zora\"};mutator(identity);target.identity=identity;snapshot=structuredClone(identity);return watchlist});if(snapshot){entry.identity=structuredClone(snapshot)}},\"mutateIdentity\");const fetchTwitterFollowers=__name(async handle=>{if(!TWITTER_API_KEY){throw new Error(\"TWITTER_API_KEY is not configured\")}const url=new URL(\"/twitter/user/info\",TWITTER_API_BASE);url.searchParams.set(\"userName\",handle);const res=await fetch(url,{headers:{\"x-api-key\":TWITTER_API_KEY}});if(!res.ok){throw new Error(`twitterapi.io HTTP ${res.status}`)}const json=await res.json();const followers=Number(json?.data?.followers??json?.data?.followersCount)??null;if(!Number.isFinite(followers)){throw new Error(\"twitterapi.io response missing follower count\")}return followers},\"fetchTwitterFollowers\");const fetchFarcasterFollowers=__name(async fid=>{const url=new URL(\"/v2/user\",FARCASTER_USER_API_BASE);url.searchParams.set(\"fid\",String(fid));const res=await fetch(url);if(!res.ok){throw new Error(`Warpcast user API HTTP ${res.status}`)}const json=await res.json();const count=Number(json?.result?.user?.followerCount);if(!Number.isFinite(count)){throw new Error(\"Farcaster user response missing followerCount\")}return count},\"fetchFarcasterFollowers\");const refreshTwitterStat=__name(async(entry,handle)=>{const current=entry.identity?.socialStats?.twitter;if(current&&current.handle?.toLowerCase()===handle.toLowerCase()&&getStatAge(current)<SOCIAL_STATS_TTL_MS){return current}let followers=null;let error;try{followers=await fetchTwitterFollowers(handle)}catch(err){error=err.message}const stat={provider:\"twitter\",handle,followers,lastCheckedAt:nowIso(),source:\"twitterapi.io\",error};await mutateIdentity(entry,identity=>{identity.socialStats=identity.socialStats??{};identity.socialStats.twitter=stat});return stat},\"refreshTwitterStat\");const refreshFarcasterStat=__name(async(entry,fid)=>{const current=entry.identity?.socialStats?.farcaster;if(current&&current.fid===fid&&getStatAge(current)<SOCIAL_STATS_TTL_MS){return current}let followers=null;let error;try{followers=await fetchFarcasterFollowers(fid)}catch(err){error=err.message}const stat={provider:\"farcaster\",handle:entry.identity?.farcasterUsername??String(fid),fid,followers,lastCheckedAt:nowIso(),source:\"api.farcaster.xyz\",error};await mutateIdentity(entry,identity=>{identity.socialStats=identity.socialStats??{};identity.socialStats.farcaster=stat});return stat},\"refreshFarcasterStat\");const shouldRunSmartFollowerAudit=__name(entry=>{if(!SMART_AUTO_RUN)return false;const lastRunAt=entry.identity?.smartFollowers?.lastCheckedAt;if(!lastRunAt)return true;return Date.now()-new Date(lastRunAt).getTime()>SMART_AUTO_REFRESH_MS},\"shouldRunSmartFollowerAudit\");const runSmartFollowerAudit=__name(async(entry,handle)=>{if(!shouldRunSmartFollowerAudit(entry)){return entry.identity?.smartFollowers??null}const result=spawnSync(\"node\",[SMART_SCRIPT_PATH,\"--handle\",handle,\"--json\"],{cwd:BASE_ROOT,encoding:\"utf-8\"});if(result.status!==0){console.warn(`[smart-followers] Moni fetch failed for @${handle}: ${result.stderr||result.stdout}`);return null}let payload;try{payload=JSON.parse(result.stdout)}catch(error){console.warn(`[smart-followers] Unable to parse JSON for @${handle}: ${error.message}`);return null}const social=payload?.social??payload?.moni??{};const topSample=Array.isArray(payload?.topSmarts)?payload.topSmarts.slice(0,5):void 0;const report={provider:\"moni\",handle,lastCheckedAt:nowIso(),totalSmarts:social?.smarts??social?.totalSmarts,moniScore:social?.moniScore??social?.score,followers:social?.followers,topSample};await mutateIdentity(entry,identity=>{identity.smartFollowers=report});return report},\"runSmartFollowerAudit\");const enforcePromisingSocialGate=__name(async entry=>{const reasons=[];const twitterHandle=extractTwitterHandle(entry);if(!twitterHandle){return{passes:false,reasons:[\"Twitter handle missing\"],stats:{}}}const twitterStat=await refreshTwitterStat(entry,twitterHandle);const farcasterFid=entry.identity?.creatorFid;const farcasterStat=farcasterFid?await refreshFarcasterStat(entry,farcasterFid):void 0;let passes=true;if(!twitterStat?.followers||twitterStat.followers<MIN_TWITTER_FOLLOWERS){passes=false;const followerText=twitterStat?.followers!==null&&twitterStat?.followers!==void 0?twitterStat.followers:\"unknown\";reasons.push(`Twitter followers ${followerText} < ${MIN_TWITTER_FOLLOWERS}`)}if(twitterStat?.error){reasons.push(`Twitter fetch error: ${twitterStat.error}`)}if(farcasterFid){if(!farcasterStat?.followers||farcasterStat.followers<MIN_FARCASTER_FOLLOWERS){passes=false;const followerText=farcasterStat?.followers!==null&&farcasterStat?.followers!==void 0?farcasterStat.followers:\"unknown\";reasons.push(`Farcaster followers ${followerText} < ${MIN_FARCASTER_FOLLOWERS}`)}if(farcasterStat?.error){reasons.push(`Farcaster fetch error: ${farcasterStat.error}`)}}if(passes&&twitterHandle){await runSmartFollowerAudit(entry,twitterHandle)}return{passes,reasons,stats:{twitter:twitterStat,farcaster:farcasterStat}}},\"enforcePromisingSocialGate\");export{enforcePromisingSocialGate};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/taygun/Masaüstü/base/ponder-base-createpool2/src/utils/socialProof.ts"],"sourcesContent":[null]}}